<template>
    <main>
        <h2 class="adoption__title">Créé la fiche adoption de ton chat</h2>
        <section class="adoption">
            <div class="adoption__left__part">
                <fieldset class="adoption__form">
                    <div class="adoption__form__pair">
                        <label class="input__name" for="lastname">Nom</label>
                        <input v-model="title" class="input" type="text" id="lastname" name="lastname" placeholder="Doe"/>
                    </div>
                    <div class="adoption__form__pair">
                        <label class="input__name" for="sexe">Sexe</label>
                        <select v-model="sex" class="input" name="sexe" id="sexe">
                            <option  v-for="sex in sexes" :key="sex.id" :value="sex.id">{{sex.name}}</option>
                        </select>
                    </div>

                    <div class="adoption__form__pair">
                        <label class="input__name" for="city">Ville</label>
                        <input v-model="city" class="input" type="text" id="city" name="city"/>
                    </div>

                    <!-- imput département  -->
                    <div class="adoption__form__pair">
                        <label class="input__name" for="department">Département</label>
                        <input @keyup="sendLocation" v-model="location_input" type="text" class="input" name="departement" id="department">
                        <div id="home__form__list" >
                            <ItemListLocation v-for="location in locations" :key="location" :name="location" :value="location.id"
                            @choiceLocation="selectedLocation" />
                        </div>
                    </div>

                    <div class="adoption__form__pair">
                        <label class="input__name" for="environment">Environnement</label>
                        <select v-model="environment" class="input" name="environment" id="environment">
                            <option v-for="environment in environments" :key="environment.id" :value="environment.id">{{environment.name}}</option> 
                        </select>
                    </div>

                    <div class="adoption__form__pair">
                        <label class="input__name" for="filter">Age</label>
                        <select v-model="age" class="input" name="filter" id="filter">
                            <option value="bebe">Bébé</option>
                            <option value="junior">Junior</option>
                            <option value="adulte">Adulte</option>
                            <option value="senior">Sénior</option>
                        </select>
                    </div>

                    <fieldset class="adoption__form__pair">
                        <div class="input__name">
                            <legend>
                            Votre chat est-il malade? <br />
                            <span>(si oui, préciser dans la déscription)</span>
                            </legend>
                        </div>
                        <div v-for="disease in diseases" :key="disease.id">
                            <input v-model="disease_input" :value="disease.id" type="radio" :id="disease.id" name="sickness"/>
                            <label :for="disease.id">{{disease.name}}</label>
                        </div> 
                    </fieldset>

                    <div class="adoption__form__pair">
                        <label class="input__name" for="vaccine">Vacciné contre</label>
                        <div v-for="vaccinate in vaccinates" :key="vaccinate.id">
                            <input  type="checkbox" :id="vaccinate.id" name="vaccinate" :value="vaccinate.id" v-model="checkedVaccins"/>
                            <label :for="vaccinate.id" > {{vaccinate.name}}</label>
                        </div>
                    </div>

                </fieldset>

                <div class="adoption__description">
                    <label class="input__name" for="description">Description</label>
                    <textarea v-model="content" class="input adoption__description__textarea" id="description" name="description">
                    </textarea>
                </div>

                <!-- Boutons à ne faire apparaître que quand le composant est appelé par ProfilePublishedSheetsLayout  -->
                <div v-if="this.$route.name === 'profile'" class="profil__adoption__buttons">
                    <button class="button__orange" type="submit">
                    Valider les modification
                    </button>
                    <button class="button__orange" type="submit">Supprimer la fiche</button>
                </div>
            </div>


            <!-- Bouton pour ajouter une photo -->
            <div class="adoption__add__picture">
                <div class="image__upload">
                    <label for="featured_image">
                        <img class="image__upload__appareil" src="../../assets/icones/Vector(13).png"/>
                    </label>
                <input type="file" id="featured_image" name="featured_image" @change="previewPictureAdd" accept=".png, .jpg, .jpeg">
                </div>
                <img class="image__upload__preview" :src="preview_picture" alt="" id="image"  >
            </div>
        </section>


        <section v-if="this.$route.name === 'cat_add'" class="information">
            <div class="information__content">
                <h2 class="information__content__title">
                        Informations réglementaires
                </h2>
                <div class="information__content__paragraphe">
                    <p> She shook her head, and shook it again, as if trying to
                            clear it, which is what she was trying to
                            do.
                            They did not realize that because of the quasi-reciprocal and circular nature of all
                            Improbability
                            calculations, anything that was Infinitely Improbable was actually very likely to happen
                            almost
                            immediately. If beauty is in the eye of the beholder, then the beholder won’t be a Vogon,
                            because
                            even
                            Vogons know how ugly they are. Think of something crazy, or if that’s too taxing just throw
                            random
                            adjectives and nouns together. He smiled the smile that Zaphod had wanted to hit and this
                            time
                            Zaphod
                            hit it.
                    </p>
                    <br>
                    <p>
                            I don’t want to buy a ticket, I just want to buy the zoo. The shorter man noticed the new
                            arrivals;
                            it
                            was pretty likely that he would, as one of them was shouting at him. Where do you stand on
                            the
                            whole
                            Babel fish argument? He learned to communicate with birds and discovered that their
                            conversation
                            was
                            fantastically boring. It was all to do with wind speed, wingspans, power-to-weight ratios
                            and a
                            fair
                            bit
                            about berries. “Zaphod! I am so happy to see you.”
                    </p>
                </div>
                <div class="information__content__regulatory">
                    <div class="information__content__regulatory__checkbox">
                        <div class="input__name__checkbox">
                            <input type="checkbox" id="permission1" name="permission1" value="permission1">
                            <label for="permission1"> She shook her head, and shook it again</label>
                        </div>
                        <div class="input__name__checkbox">
                            <input type="checkbox" id="permission2" name="permission2" value="permission2">
                            <label for="permission2"> She shook her head, and shook it again</label>
                        </div>
                        <div class="input__name__checkbox">
                            <input type="checkbox" id="permission3" name="permission3" value="permission3">
                            <label for="permission3"> She shook her head, and shook it again</label>
                        </div>
                        <div class="input__name__checkbox">
                            <input type="checkbox" id="permission4" name="permission4" value="permission4">
                            <label for="permission4"> She shook her head, and shook it again</label>
                        </div>
                    </div>
                        <div class=" button__adoption__add">
                            <button v-on:click="sendNewCat" type="submit" class="button__orange" > Valider la création de la fiche</button>
                        </div>
                        <div>
                        <p v-for="error in errors" v-bind:key="error">{{error}}</p>
                        </div>
                    </div>
                    <img class="img__cat__information" src="../../assets/img/purr-cat-21.png" alt="">
                </div>
        </section>
    </main>

</template>

<script> 
import NewCat from '@/services/cat/NewCat';
import LocationService from '@/services/cat/LocationService';
import FindAllService from '@/services/taxonomies/FindAllService';
import ItemListLocation from '@/components/home/ItemListLocation';

export default {
    name: "CatAddLayout",
    components: {
         ItemListLocation
        },

    data() {
        return {

            // Recuperation des valeurs mise dans la fiche
            errors: [],
            title: null,
            sex: null,
            city: null,
            location_input: null,
            environment: null,
            age: null,
            checkedVaccins: [],
            disease_input: null,
            content: null,

            // Recuperation taxonomies
            environments: [],
            vaccinates: [],
            sexes: [],
            locations: [],
            diseases: [],
            
            picture_file: null,
            preview_picture: ''
        }
    },
    async mounted() {
        this.environments = await FindAllService.findAllEnvironment();
        this.sexes = await FindAllService.findAllSex();
        this.vaccinates = await FindAllService.findAllVaccinate();
        this.diseases = await FindAllService.findAllDisease();

    },
    
    methods: {

        previewPictureAdd(event) {
        // Revisualisation de l'image
            this.picture_file = event.target.files[0];
            console.log(event.target.files[0])

            this.preview_picture = URL.createObjectURL(this.picture_file);

        },

        async sendNewCat() {
             this.errors = [];
             console.log(this.location_input.id)
             // Validation du contenu du formulaire
             if(!this.title) {
                 this.errors.push("Title cannot be empty");
             }
             if(!this.sex) {
                 this.errors.push("Sex cannot be empty");
             }
            if(!this.location_input) {
                this.errors.push("Localisation cannot be empty");
            }
             if(!this.city) {
                 this.errors.push("City cannot be empty");
             }
             if(!this.age) {
                this.errors.push("Age cannot be empty");
             }
              if(!this.disease_input) {
                this.errors.push("Disease cannot be empty");
              }
             if(!this.content) {
                 this.errors.push("Content cannot be empty");
             }
             if(this.errors.length === 0) {
                 let params = {
                     "title": this.title,
                     "sex": this.sex,
                     "location": this.location_input,
                     "meta": {"age": this.age, "city": this.city},
                     "vaccinate": this.checkedVaccins,
                     "diseases": this.disease_input,
                     "content": this.content,
                     "status": 'publish'
                 }
                 switch (this.$store.getters.getRole) {
                  case 'owner':
                    params.status = "publish"
                    break;
                 }
                 const response = await NewCat.create(params);
                 // Reception de la réponse et affichage
                 if(response.id) {
                    const postId = response.id
                    const createPicture = await NewCat.uploadPicture(postId, this.picture_file.name, {
                        headers: {"Content-Type": "image/jpeg"}
                    }, this.picture_file)
                    // console.log(createPicture);
                    if (createPicture.id) {
                        const updatePost = await NewCat.addFeaturedMedia(postId, {
                            "featured_media": createPicture.id
                        })
                        console.log(updatePost);
                    }
                    this.$router.push({name: 'home'});
                 } else {
                     alert(response.message);
                 }
            }
        },

        // input localisation
        async sendLocation() {
        this.locations = [];
        document.querySelector('#home__form__list').style.height = '0';

        if (this.location_input != '') {
            const response = await LocationService.find(this.location_input);
            console.log(response);
            document.querySelector('#home__form__list').style.height = '12rem';
            response.forEach(location => {
            if (location.nom.toLowerCase().includes(this.location_input.toLowerCase())) {
                this.locations.push(location.nom)
            }
            });
        }
        },
        selectedLocation(event) {
            const choiceLocation = event.currentTarget.textContent;
            this.location_input = choiceLocation
            this.locations = [];
            document.querySelector('#home__form__list').style.height = '0';
        }
        
    },
}
</script>

<style lang="scss" scoped>
.adoption__add__picture{
    position: relative;
}

.image__upload {
    

    input{
        display: none;
     }
    &__preview{
        position: absolute;
        width: 100%;
        object-fit: cover;
    }
    
     &__appareil{
        cursor: pointer;
     }
}

.adoption__form__pair {
    #home__form__list {
    overflow-x: auto;
  }

  #home__form__list::-webkit-scrollbar {
    display: none;
  }

  .input {
    margin-bottom: 1rem;
  }
}
</style>